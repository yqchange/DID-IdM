import{ec as e}from"elliptic";import{createJWT as r,verifyJWT as t,SimpleSigner as i,toEthereumAddress as n}from"did-jwt";export{SimpleSigner}from"did-jwt";import{createVerifiableCredentialJwt as o,verifyPresentation as a}from"did-jwt-vc";import s from"ethr-did-resolver";import{getResolver as c}from"web-did-resolver";import{Resolver as u}from"did-resolver";import{isMNID as l,decode as d}from"mnid";function f(){return(f=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}).apply(this,arguments)}var v,p;!function(e){e.Function="function",e.Event="event",e.Constructor="constructor",e.Fallback="fallback"}(v||(v={})),function(e){e.Pure="pure",e.View="view",e.NonPayable="nonpayable",e.Payable="payable"}(p||(p={}));var h,m=function(e){if("object"!=typeof e)return!1;if(0===Object.keys(e).length)return!0;for(var r=0,t=["from","to","data","value","gasPrice","gas"];r<t.length;r++)if(t[r]in e)return!0;return!1},y=function(e,r){for(var t=e.name+"(",i=e.inputs||[],n=0;n<i.length;n++){var o=i[n],a=o.type+" ";t+=a+="string"===o.type?'"'+r[n]+'"':""+r[n],i.length-1!==n&&(t+=", ")}return t+")"},E=function(e){return function(r){return{at:function(t){var i={};return function(e){return e.filter(function(e){return e.type===v.Function&&e.name&&!e.constant})}(r).forEach(function(r){r.name&&(i[r.name]=function(){var i={},n=[].slice.call(arguments),o=(r.inputs||[]).length;m(n[o])&&(i=n.splice(o,1)[0]);var a=f({},i,{to:t,function:y(r,n)});if(!e)return a;var s=n[n.length-1];return e(a,s)})}),f({},i,{abi:r,address:t})}}}},g=new e("secp256k1");!function(e){e.DISCLOSURE_REQUEST="shareReq",e.DISCLOSURE_RESPONSE="shareResp",e.TYPED_DATA_SIGNATURE_REQUEST="eip712Req",e.VERIFICATION_SIGNATURE_REQUEST="verReq",e.ETH_TX_REQUEST="ethtx",e.PERSONAL_SIGN_REQUEST="personalSigReq",e.PRESENTATION_REQUEST="presentationReq"}(h||(h={}));var b=function(){function e(e){var r=e.did,t=e.address,o=e.privateKey,a=e.signer,d=e.ethrConfig,v=e.resolver;if(a?this.signer=a:o&&(this.signer=i(o)),r)this.did=r;else if(t)l(t)&&(this.did="did:uport:"+t),t.match("^0x[0-9a-fA-F]{40}$")&&(this.did="did:ethr:"+t);else if(o){var p=g.keyFromPrivate(o),h=n(p.getPublic("hex"));this.did="did:ethr:"+h}if(v)this.resolver=v;else{var m=s.getResolver(d||{}),y=c();this.resolver=new u(f({},y,m,{https:y.web}))}}e.createIdentity=function(){var e=g.genKeyPair(),r=e.getPublic("hex"),t=e.getPrivate("hex");return{did:"did:ethr:"+n(r),privateKey:t}};var v=e.prototype;return v.signJWT=function(e,t){return this.did&&this.signer?r(e,{issuer:this.did,signer:this.signer,alg:this.did.match("^did:uport:")||l(this.did)?"ES256K":"ES256K-R",expiresIn:t}):Promise.reject(new Error("No Signing Identity configured"))},v.createDisclosureRequest=function(e,r){void 0===e&&(e={}),void 0===r&&(r=600);var t={};if(e.requested&&(t.requested=e.requested),e.verified&&(t.verified=e.verified),e.claims&&(t.claims=e.claims),e.notifications&&(t.permissions=["notifications"]),e.callbackUrl&&(t.callback=e.callbackUrl),e.networkId&&(t.net=e.networkId),e.rpcUrl){if(!e.networkId)return Promise.reject(new Error("rpcUrl was specified but no networkId"));t.rpc=e.rpcUrl}if(e.vc&&(t.vc=e.vc),e.exp&&(t.exp=e.exp),e.accountType){if(!(["general","segregated","keypair","none"].indexOf(e.accountType)>=0))return Promise.reject(new Error("Unsupported accountType "+e.accountType));t.act=e.accountType}return e.boxPub&&(t.boxPub=e.boxPub),this.signJWT(f({},t,{type:h.DISCLOSURE_REQUEST}),e.exp?void 0:r)},v.createVerification=function(e){return this.signJWT({sub:e.sub,claim:e.claim,exp:e.exp,vc:e.vc,callbackUrl:e.callbackUrl})},v.createVerificationSignatureRequest=function(e,r){return this.signJWT({unsignedClaim:e,sub:r.sub,riss:r.riss,aud:r.aud,vc:r.vc,callback:r.callbackUrl,type:h.VERIFICATION_SIGNATURE_REQUEST,rexp:r.rexp},r.expiresIn)},v.createTypedDataSignatureRequest=function(e,r){var t=void 0===r?{}:r,i=t.from,n=t.net,o=t.callback;try{for(var a=0,s=["types","primaryType","message","domain"];a<s.length;a++){var c=s[a];if(!e[c])throw new Error("Invalid EIP712 Request, must include '"+c+"'")}return Promise.resolve(this.signJWT({typedData:e,from:i,net:n,callback:o,type:h.TYPED_DATA_SIGNATURE_REQUEST}))}catch(e){return Promise.reject(e)}},v.createPersonalSignRequest=function(e,r){var t=void 0===r?{}:r;return this.signJWT({data:e,from:t.from,net:t.net,callback:t.callback,type:h.PERSONAL_SIGN_REQUEST})},v.createTxRequest=function(e,r){var t=void 0===r?{}:r,i=t.callbackUrl,n=t.exp,o=void 0===n?600:n,a=t.networkId,s=t.label,c={};return i&&(c.callback=i),a&&(c.net=a),s&&(c.label=s),this.signJWT(f({},c,e,{type:h.ETH_TX_REQUEST}),o)},v.createDisclosureResponse=function(e,r){void 0===e&&(e={}),void 0===r&&(r=600);try{var i=function(){return n.signJWT(f({},e,{type:h.DISCLOSURE_RESPONSE}),r)},n=this,o=function(){if(e.req)return Promise.resolve(t(e.req,{resolver:n.resolver})).then(function(r){r.issuer&&(e.aud=r.issuer)})}();return Promise.resolve(o&&o.then?o.then(i):i())}catch(e){return Promise.reject(e)}},v.processDisclosurePayload=function(e){var r=e.doc,i=e.payload;try{var n=this,o=i.own,a=void 0===o?{}:o,s=i.capabilities,c=void 0===s?[]:s,u=i.nad,l=i.dad,v=i.iss,p=i.boxPub,h=i.verified,m=function(e,r){if(null==e)return{};var t,i,n={},o=Object.keys(e);for(i=0;i<o.length;i++)r.indexOf(t=o[i])>=0||(n[t]=e[t]);return n}(i,["own","capabilities","aud","req","iat","exp","type","nad","dad","iss","boxPub","verified"]),y=r.uportProfile,E=f({did:v,boxPub:p},a,void 0===y?{}:y,m);l&&(E.deviceKey=l),u&&(E.mnid=u,E.address=d(u).address),1===c.length&&(E.pushToken=c[0]);var g=function(){if(h){var e=[],r=h.map(function(r){return t(r,{resolver:n.resolver,audience:n.did}).catch(function(){return e.push(r),Promise.resolve(void 0)})});return Promise.resolve(Promise.all(r)).then(function(r){var t=[];r.forEach(function(e){e&&t.push(f({},e.payload,{jwt:e.jwt}))}),E.verified=t,E.invalid=e})}}();return Promise.resolve(g&&g.then?g.then(function(){return E}):E)}catch(e){return Promise.reject(e)}},v.authenticateDisclosureResponse=function(e,r){try{var i=this;return Promise.resolve(t(e,{resolver:i.resolver,audience:i.did,callbackUrl:r,auth:!0})).then(function(e){var r=e.payload,n=e.doc;if(r.req)return Promise.resolve(t(r.req,{resolver:i.resolver,audience:i.did})).then(function(e){var t=e.payload;if(t.type!==h.DISCLOSURE_REQUEST)throw new Error("Challenge payload type invalid: "+t.type);return i.processDisclosurePayload({payload:r,doc:n})});throw new Error("Challenge was not included in response")})}catch(e){return Promise.reject(e)}},v.verifyDisclosure=function(e){try{var r=this;return Promise.resolve(t(e,{resolver:r.resolver,audience:r.did})).then(function(e){return r.processDisclosurePayload({payload:e.payload,doc:e.doc})})}catch(e){return Promise.reject(e)}},v.issueVerifiableCredential=function(e){try{return this.did&&this.signer?Promise.resolve(o(e,{did:this.did,signer:this.signer})):Promise.reject(new Error("No Signing Identity configured"))}catch(e){return Promise.reject(e)}},v.verifyPresentation=function(e){try{return Promise.resolve(a(e,this.resolver))}catch(e){return Promise.reject(e)}},v.contract=function(e){var r=this;return E(function(e,t){return e.function&&(e.fn=e.function),delete e.function,r.createTxRequest(e,t)}.bind(this))(e)},e}();export{E as ContractFactory,b as Credentials};
//# sourceMappingURL=index.esm.js.map
